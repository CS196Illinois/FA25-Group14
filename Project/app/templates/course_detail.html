{% extends "base.html" %} {% block title %}{{ course.course_code }} - {{
course.course_name }}{% endblock %} {% block content %}
<div class="course-detail">
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <ol>
      <li><a href="/">Course Compass</a></li>
      <li><a href="/#courses">Course Explorer</a></li>
      <li aria-current="page">{{ course.course_code }}</li>
    </ol>
  </nav>

  <div class="course-content">
    <section class="course-main">
      <header class="course-header">
        <div class="course-title-block">
          <h1>{{ course.course_code }}</h1>
          <h2>{{ course.course_name }}</h2>
          <div class="course-badges">
            <span class="badge badge-primary"
              >{{ course.credit_hours or 'N/A' }} Credit Hours</span
            >
            <span class="badge badge-secondary"
              >{{ course.department or 'Unknown Dept' }}</span
            >
            {% if course.gen_ed_requirements %}

            <div class="gened-list">
              {% set geneds = course.gen_ed_requirements.split(';') if ';' in
              course.gen_ed_requirements else course.gen_ed_requirements.split(',')
              %} {% for gened in geneds %} {% if gened.strip() %}
              <span class="badge badge-gened">{{ gened.strip() }}</span>
              {% endif %} {% endfor %}
            </div>

            {% endif %}
          </div>
        </div>
      </header>

      <div class="course-section">
        <h3>Course Description</h3>
        <div class="course-description">
          {% if course.description %}
          <p>{{ course.description }}</p>
          {% else %}
          <p class="empty-state">No description available for this course.</p>
          {% endif %}
        </div>
      </div>

      <div class="course-section">
        <h3>Course Information</h3>
        <dl class="course-info-grid">
          <dt>Course Code</dt>
          <dd>{{ course.course_code }}</dd>

          <dt>Department</dt>
          <dd>{{ course.department or 'Not specified' }}</dd>

          <dt>Credit Hours</dt>
          <dd>{{ course.credit_hours or 'Not specified' }}</dd>

          {% if course.gen_ed_requirements %}
          <dt>Gen Ed Categories</dt>
          <dd>
            {% set geneds = course.gen_ed_requirements.split(';') if ';' in
            course.gen_ed_requirements else
            course.gen_ed_requirements.split(',') %} {% if geneds %} {{ geneds |
            map('trim') | select | join(', ') }} {% else %} None listed {% endif
            %}
          </dd>
          {% endif %}
        </dl>
      </div>

      <!-- Reviews Section -->
      <div class="course-section">
        <div class="reviews-header">
          <h3>Student Reviews</h3>
          {% if current_user.is_authenticated %} {% if user_review %}
          <div class="review-actions">
            <a
              href="{{ url_for('main.edit_review', course_code=course.course_code) }}"
              class="btn btn-ghost btn-sm"
              >Edit My Review</a
            >
            <form
              method="POST"
              action="{{ url_for('main.delete_review', course_code=course.course_code) }}"
              class="delete-form"
              onsubmit="return confirm('Are you sure you want to delete your review?')"
            >
              <button type="submit" class="btn btn-ghost btn-sm btn-danger">
                Delete My Review
              </button>
            </form>
          </div>
          {% else %}
          <a
            href="{{ url_for('main.add_review', course_code=course.course_code) }}"
            class="btn btn-primary"
            >Leave a Review</a
          >
          {% endif %} {% else %}
          <div class="login-prompt">
            <a
              href="{{ url_for('main.login', next=url_for('main.add_review', course_code=course.course_code)) }}"
              class="btn btn-primary"
              >Log In to Review</a
            >
            <p class="login-hint">Share your experience with other students</p>
          </div>
          {% endif %}
        </div>

        {% if reviews %}
        <div class="reviews-list">
          {% for review in reviews %}
          <article
            class="review-item {% if current_user.is_authenticated and review.user_id == current_user.id %}user-review{% endif %}"
          >
            <header class="review-header">
              <div class="review-meta">
                <span class="reviewer-name">{{ review.author.name }}</span>
                <span class="review-date">{{ review.time_ago }}</span>
                {% if review.semester_taken %}
                <span class="semester">{{ review.semester_taken }}</span>
                {% endif %} {% if review.grade_received %}
                <span class="grade">Grade: {{ review.grade_received }}</span>
                {% endif %}
              </div>
              <div class="review-ratings">
                <div class="rating-item">
                  <span class="rating-label">Overall:</span>
                  <span class="stars">{{ review.rating_stars }}</span>
                </div>
                <div class="rating-item">
                  <span class="rating-label">Difficulty:</span>
                  <span class="rating-value">{{ review.difficulty }}/5</span>
                </div>
                <div class="rating-item">
                  <span class="rating-label">Workload:</span>
                  <span class="rating-value">{{ review.workload }}/5</span>
                </div>
              </div>
            </header>

            <div class="review-content">
              <h4 class="review-title">{{ review.title }}</h4>
              <p class="review-comment">{{ review.comment }}</p>
              {% if review.professor %}
              <p class="review-professor">Professor: {{ review.professor }}</p>
              {% endif %}
            </div>
          </article>
          {% endfor %}
        </div>
        {% else %}
        <div class="no-reviews">
          <p>No reviews yet for this course.</p>
          {% if current_user.is_authenticated %}
          <p>
            Be the first to
            <a
              href="{{ url_for('main.add_review', course_code=course.course_code) }}"
              >share your experience</a
            >!
          </p>
          {% else %}
          <p>
            <a href="{{ url_for('main.login') }}">Log in</a> to be the first to
            review this course.
          </p>
          {% endif %}
        </div>
        {% endif %}
      </div>

      <!-- Course Chat Section -->
      {% if current_user.is_authenticated %}
      <div class="course-chat-section">
        <div class="chat-header">
          <h3>Course Discussion</h3>
          <p class="chat-subtitle">Chat with other students taking {{ course.course_code }}</p>
        </div>

        <div class="chat-container" id="chat-container">
          <div class="chat-messages" id="chat-messages">
            <div class="chat-loading">
              <div class="loading-spinner"></div>
              <p>Loading messages...</p>
            </div>
          </div>

          <div class="chat-input-container">
            <form id="chat-form" class="chat-form">
              <input
                type="text"
                id="chat-input"
                class="chat-input"
                placeholder="Type a message..."
                maxlength="1000"
                autocomplete="off"
                required
              />
              <button type="submit" class="btn btn-primary chat-send-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                Send
              </button>
            </form>
            <p class="chat-hint">Press Enter to send • Messages are visible to all students</p>
          </div>
        </div>
      </div>
      {% else %}
      <div class="course-chat-section">
        <div class="chat-login-prompt">
          <h3>Course Discussion</h3>
          <p>Please <a href="{{ url_for('main.login') }}">log in</a> to join the conversation about {{ course.course_code }}</p>
        </div>
      </div>
      {% endif %}
    </section>

    <aside class="course-sidebar">
      {% if gpa_stats %}
      <div class="stats-section">
        <h3>GPA Statistics</h3>
        <div class="course-stats">
          <div class="stat-item">
            <span class="stat-label">Overall GPA</span>
            <span class="stat-value stat-gpa">{{ gpa_stats.overall_gpa }}</span>
          </div>
          {% if gpa_stats.recent_gpa %}
          <div class="stat-item">
            <span class="stat-label">Recent GPA (Last 3 Terms)</span>
            <span class="stat-value stat-gpa">{{ gpa_stats.recent_gpa }}</span>
          </div>
          {% endif %}
          <div class="stat-item">
            <span class="stat-label">Total Students</span>
            <span class="stat-value">{{ "{:,}".format(gpa_stats.total_students) }}</span>
          </div>
        </div>

        {% if gpa_stats.top_professors %}
        <div class="gpa-professors">
          <h4>Top Professors</h4>
          <ul class="professor-list">
            {% for prof in gpa_stats.top_professors %}
            <li class="professor-item">
              <span class="professor-name">{{ prof.name }}</span>
              <span class="professor-gpa">{{ prof.gpa }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if gpa_stats.recent_semesters %}
        <div class="gpa-trends">
          <h4>Recent Semesters</h4>
          <ul class="semester-list">
            {% for sem in gpa_stats.recent_semesters %}
            <li class="semester-item">
              <span class="semester-name">{{ sem.semester }}</span>
              <span class="semester-gpa">{{ sem.gpa }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
      {% endif %}

      {% if reviews %}
      <div class="stats-section">
        <h3>Student Reviews Statistics</h3>
        <div class="course-stats">
          <div class="stat-item">
            <span class="stat-label">Average Rating</span>
            <div class="rating-display">
              {% for i in range(1, 6) %}
              <span class="star {% if i <= avg_rating %}filled{% endif %}"
                >★</span
              >
              {% endfor %}
              <span class="rating-text"
                >({{ "%.1f"|format(avg_rating) }}/5)</span
              >
            </div>
          </div>
          <div class="stat-item">
            <span class="stat-label">Difficulty</span>
            <span class="stat-value"
              >{{ "%.1f"|format(avg_difficulty) }}/5</span
            >
          </div>
          <div class="stat-item">
            <span class="stat-label">Workload</span>
            <span class="stat-value">{{ "%.1f"|format(avg_workload) }}/5</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Reviews</span>
            <span class="stat-value"
              >{{ reviews|length }} review{{ 's' if reviews|length != 1 else ''
              }}</span
            >
          </div>
        </div>
      </div>
      {% endif %} {% if related_courses %}
      <div class="related-section">
        <h3>Related Courses in {{ course.department }}</h3>
        <div class="related-courses">
          {% for related in related_courses %}
          <article class="related-course-card">
            <a href="/course/{{ related.course_code }}" class="related-link">
              <header>
                <h4>{{ related.course_code }}</h4>
                <span class="related-credits"
                  >{{ related.credit_hours or 'N/A' }} hrs</span
                >
              </header>
              <p class="related-title">{{ related.course_name }}</p>
              {% if related.description %}
              <p class="related-description">
                {{ related.description[:120] }}{% if related.description|length
                > 120 %}...{% endif %}
              </p>
              {% endif %}
            </a>
          </article>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="action-section">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
          <a href="/#courses" class="btn btn-secondary">Back to Explorer</a>
          <button class="btn btn-ghost" onclick="window.print()">
            Print Course Info
          </button>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
// Chat functionality
{% if current_user.is_authenticated %}
const COURSE_CODE = "{{ course.course_code }}";
const CURRENT_USER_ID = {{ current_user.id }};
const chatMessages = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
let lastMessageId = 0;
let isLoadingMessages = false;

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function createMessageElement(msg) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${msg.is_own ? 'chat-message-own' : ''}`;
  messageDiv.dataset.messageId = msg.id;
  
  const deleteBtn = msg.is_own ? 
    `<button class="message-delete-btn" onclick="deleteMessage(${msg.id})" title="Delete message">×</button>` : '';
  
  messageDiv.innerHTML = `
    <div class="message-header">
      <span class="message-author">${escapeHtml(msg.author_name)}</span>
      <span class="message-time">${escapeHtml(msg.time_ago)}</span>
      ${deleteBtn}
    </div>
    <div class="message-content">${escapeHtml(msg.content)}</div>
  `;
  
  return messageDiv;
}

async function loadMessages() {
  if (isLoadingMessages) return;
  isLoadingMessages = true;
  
  try {
    const response = await fetch(`/api/messages/${COURSE_CODE}`);
    if (!response.ok) throw new Error('Failed to load messages');
    
    const data = await response.json();
    
    // Clear loading state
    chatMessages.innerHTML = '';
    
    if (data.messages.length === 0) {
      chatMessages.innerHTML = '<div class="chat-empty">No messages yet. Be the first to start the conversation!</div>';
    } else {
      data.messages.forEach(msg => {
        chatMessages.appendChild(createMessageElement(msg));
        lastMessageId = Math.max(lastMessageId, msg.id);
      });
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  } catch (error) {
    console.error('Error loading messages:', error);
    chatMessages.innerHTML = '<div class="chat-error">Failed to load messages. Please refresh the page.</div>';
  } finally {
    isLoadingMessages = false;
  }
}

async function sendMessage(content) {
  try {
    const response = await fetch(`/api/messages/${COURSE_CODE}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to send message');
    }
    
    const data = await response.json();
    
    // Remove empty state if exists
    const emptyState = chatMessages.querySelector('.chat-empty');
    if (emptyState) {
      emptyState.remove();
    }
    
    // Add new message
    chatMessages.appendChild(createMessageElement(data.message));
    lastMessageId = Math.max(lastMessageId, data.message.id);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Clear input
    chatInput.value = '';
  } catch (error) {
    console.error('Error sending message:', error);
    alert(error.message || 'Failed to send message');
  }
}

async function deleteMessage(messageId) {
  if (!confirm('Are you sure you want to delete this message?')) return;
  
  try {
    const response = await fetch(`/api/messages/${messageId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) throw new Error('Failed to delete message');
    
    // Remove message from UI
    const messageElement = chatMessages.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
      messageElement.remove();
    }
    
    // Check if chat is now empty
    if (chatMessages.children.length === 0) {
      chatMessages.innerHTML = '<div class="chat-empty">No messages yet. Be the first to start the conversation!</div>';
    }
  } catch (error) {
    console.error('Error deleting message:', error);
    alert('Failed to delete message');
  }
}

// Event listeners
chatForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const content = chatInput.value.trim();
  if (content) {
    sendMessage(content);
  }
});

// Auto-refresh messages every 5 seconds
setInterval(async () => {
  if (document.hidden || isLoadingMessages) return;
  
  try {
    const response = await fetch(`/api/messages/${COURSE_CODE}`);
    if (!response.ok) return;
    
    const data = await response.json();
    
    // Only add new messages (don't reload all)
    const newMessages = data.messages.filter(msg => msg.id > lastMessageId);
    
    newMessages.forEach(msg => {
      // Remove empty state if exists
      const emptyState = chatMessages.querySelector('.chat-empty');
      if (emptyState) {
        emptyState.remove();
      }
      
      chatMessages.appendChild(createMessageElement(msg));
      lastMessageId = Math.max(lastMessageId, msg.id);
    });
    
    // Auto-scroll if user is near bottom
    const isNearBottom = chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight < 100;
    if (newMessages.length > 0 && isNearBottom) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  } catch (error) {
    console.error('Error refreshing messages:', error);
  }
}, 5000);

// Initial load
loadMessages();
{% endif %}
</script>
{% endblock %}
